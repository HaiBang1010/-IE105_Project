import os
import pandas as pd
import json
from androguard.core.bytecodes.apk import APK

def extract_permissions(apk_path):
    """Trích xuất quyền từ file APK"""
    try:
        apk = APK(apk_path)
        permissions = apk.get_permissions()
        return list(permissions)
    except Exception as e:
        print(f"Error processing {apk_path}: {str(e)}")
        return []

def process_malware_folder(folder_path, malware_type):
    """Xử lý tất cả APK malware trong thư mục và trích xuất quyền"""
    data = []
    for root, dirs, files in os.walk(folder_path):
        for file in files:
            if file.endswith(".apk"):
                apk_path = os.path.join(root, file)
                try:
                    permissions = extract_permissions(apk_path)
                    if permissions:
                        data.append({
                            "filename": file,
                            "permissions": permissions,
                            "malware_type": malware_type,
                            "label": "malware"
                        })
                        print(f"Processed malware: {file}")
                except Exception as e:
                    print(f"Error processing {file}: {e}")
    return data

def create_malware_dataset():
    """Tạo dataset từ các quyền của APK malware"""
    # Tạo thư mục datacsv nếu chưa tồn tại
    if not os.path.exists('data/datacsv'):
        os.makedirs('data/datacsv')
    
    # Định nghĩa các loại malware
    malware_types = {
        'SMSmalware': 'SMSmalware',
        'Scareware': 'Scareware',
        'Ransomware': 'Ransomware',
        'Adware': 'Adware'
    }
    
    # Tạo dictionary để lưu trữ tất cả các quyền
    all_permissions = set()
    all_data = []
    
    # Xử lý từng thư mục malware
    for folder, malware_type in malware_types.items():
        folder_path = os.path.join('data', folder)
        if os.path.exists(folder_path):
            print(f"\nProcessing {malware_type} APKs from {folder_path}...")
            folder_data = process_malware_folder(folder_path, malware_type)
            if folder_data:
                all_data.extend(folder_data)
                # Cập nhật tập quyền
                for item in folder_data:
                    all_permissions.update(item['permissions'])
                print(f"Processed {len(folder_data)} {malware_type} APKs")
            else:
                print(f"No APKs found in {folder_path}")
    
    # Tạo DataFrame và lưu vào CSV
    if all_data:
        df = pd.DataFrame(all_data)
        output_file = 'data/datacsv/malware_permissions.csv'
        df.to_csv(output_file, index=False)
        print(f"\nSaved {len(all_data)} malware APKs to {output_file}")
        
        # Lưu danh sách tất cả các quyền
        with open('data/datacsv/malware_permissions.json', 'w') as f:
            json.dump(list(all_permissions), f)
        
        print(f"Total unique permissions found in malware: {len(all_permissions)}")
    else:
        print("No malware APKs were processed!")

def main():
    print("Starting malware APK processing and dataset creation...")
    create_malware_dataset()
    print("Malware processing completed!")

if __name__ == "__main__":
    main() 